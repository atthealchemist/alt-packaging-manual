# Глава 2. Создание и сборка пакетов

И здесь начинается самое интересное и сложное.
Скажу сразу: не пытайся преждевременно автоматизировать этот этап, постарайся понять его максимально глубоко, после чего предпринимай какие-либо действия.

Так что пристегнись, мы начинаем!

Предыстория:
Александру Сергеевичу кровь из носу потребовалось "подделать" в домашней сети сервер ВКонтакте, чтобы узнать, с кем так часто переписывается его барышня.
Немного погуглив, он нашёл бесплатное, простое и классное решение - [mitmproxy](https://github.com/mitmproxy/mitmproxy), которое с успехом использовал.
После чего решил поделиться этим опытом со всеми своими знакомыми и создать для них готовый пакет с этой утилитой.

## Структура пакета

Прежде чем пытаться что-то начать собирать, нужно понять структуру пакетов в AltLinux.

Разные разработчики делают разные структуры, но в целом у всех всё выглядит примерно так:
```
.
└── mitmproxy-package
    ├── .git
    ├── .gear
    │   └── rules (*)
    ├── mitmproxy.spec (*)
    └── mitmproxy-src  # исходники самой программы, которую ты собираешься опакетить
        ├── CHANGELOG.md
        ├── codecov.yml
        ├── CONTRIBUTING.md
        ├── docs
        ├── examples
        ├── .gitattributes
        ├── .github
        ├── .gitignore
        ├── LICENSE
        ├── MANIFEST.in
        ├── mitmproxy
        ├── README.md
        ├── release
        ├── SECURITY.md
        ├── setup.cfg
        ├── setup.py
        ├── test
        ├── tox.ini
        └── web
```

Звёздочками (*) я обозначил файлы, которые используются Hasher при сборке пакета.

### С чего начинается пакет?

Каждый пакет начинается с инициализации в нём пустого git репозитория. Или "реинициализации" существующего.

Реинициализация, если можно так выразиться, представляет собой удаление старого репозитория и создание нового.
```bash
$ rm -r .git/  # Если нам требуется "реинициализировать" существующий git-репозиторий
$ git init  # Инициализируем новый git-репозиторий
```

После чего создаём два файла, которые собственно и отличают наш пакет от простых исходников.
- `.gear/rules` - файл с правилами для сборки этого пакета Hasher'ом.
- `<package_name>.spec` - описание пакета.

```bash
$ mkdir -p .gear/ && touch .gear/rules
$ touch <package_name>.spec
```

О них дальше и пойдёт речь.

### Файл `.gear/rules` - правила Hasher для сборки конкретного пакета

В этом файле описаны правила для Hasher, а именно:
- откуда и что она будет собирать
- куда она запишет готовый пакет
- ... (дополнить)

В простых случаях этот файл обычно выглядит так:

```bash
[pushkeen@localhost mitmproxy-package]$ cat .gear/rules
tar.gz: targetTag:mitmproxy-src
```

В этой единственной строчке мы указываем:
- что для конкретной версии приложения (targetTag) в пакете (пусть она будет 8.0.0)
- мы берём наши исходники из каталога `mitmproxy-src`
- и мы пакуем их в архив `mitmproxy-src-8.0.0.tar.gz`

### Файл `mitmproxy.spec` - спецификация (от слова Specification - spec) нашего пакета

Заглянем внутрь файла `mitmproxy.spec`.
Что нам важно здесь знать?

```yaml
# Макросом define мы можем создать т.н. переменные, которые использовать дальше по всему конкретному spec-файлу
%define program_name mitmproxy

# Название нашего пакета, такое, под каким мы будем устанавливать его из репозиториев
# $ sudo apt-get install mitmproxy
Name: mitmproxy
# Версия нашего пакета
Version: 8.0.0
# Версия сборки нами нашего пакета. Т.е, сколько раз этот пакет собирался и изменялся.
Release: alt1

# Короткое описание пакета
Summary: An interactive TLS-capable intercepting HTTP proxy for penetration testers and software developers. 
# Лицензия пакетируемой нами программы. В данном случае mitmproxy публикуется под MIT лицензией.
License: MIT
# Категория приложений, к которой относится наш пакет
Group: Networking/Other

# Адрес сайта нашей программы
# Здесь может быть так же адрес сайта с документацией программы или адрес репозитория с программой
Url: https://mitmproxy.org/
# Тот, кто собирает пакет с этой программой (помнишь, мы с тобой заводили для этого GPG ключ)
Packager: Alexander Pushkin <pushkeen@altlinux.org>
# Архитектура пакета
# Т.к. в данном случае у нас программа написана на Python 3, она по сути является мультиплатформенной
# и не привязана к какой-то конкретной архитектуре
BuildArch: noarch
# Путь к архиву с исходниками нашего пакета. Из него будет собираться srpm - специальный пакет,
# содержащий в себе только исходные тексты нашей программы.
Source: %name-%version.tar.gz

# Основные зависимости, требуемые для сборки пакета.
BuildRequires(pre): rpm-build-python3

# Расширенное описание пакета
%description
mitmproxy is an interactive, SSL/TLS-capable intercepting proxy with a console interface for HTTP/1, HTTP/2, and WebSockets.

mitmdump is the command-line version of mitmproxy. Think tcpdump for HTTP.

mitmweb is a web-based interface for mitmproxy.

# Дальше начинается описание сборочных стадий

# Определение стадии подготовки
%prep

# Определение стадии установки
%setup

# Определение стадии сборки
%build

# Вызов макроса для сборки python3 пакета
%python3_build

# Определение стадии установки
%install

# Вызов макроса для установки python3 пакета в систему
%python3_install

# Определение стадии описания файлов, входящих в пакет
%files
%python3_sitelibdir/%program_name/
%python3_sitelibdir/*.egg-info

# Список изменений пакета.
# Ведётся разработчиками, чтобы указывать особенности конкретных сборок.
# Например, если был применён какой-то особый патч или интегрирован дополнительный модуль.
%changelog
* Fri Jun 3 2022 Alexander Pushkin <pushkeen@altlinux.org> 8.0.0-alt1
Initial build
```

### Предварительная сборка пакета в Hasher

После того, как мы создали наш пакет, хочется проверить - а работает ли он? А корректно устанавливается? А смогут ли им пользоваться *другие пользователи*?

Для того, чтобы максимально упростить жизнь мэйнтейнерам (и им сочувствующим), была создана утилита hsh
В итоге сборка пакета превратилась в использование всего одной команды:

```bash
$ sudo hsh --cleanup-only ${pathToSandbox}/hasher
```

TODO: ДОПИСАТЬ! ОЧЕНЬ ВАЖНЫЙ РАЗДЕЛ!